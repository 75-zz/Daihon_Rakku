# 要件定義：低コスト脚本生成パイプライン（Claude Code対応）

## 1. 目的
ユーザーが入力した作品コンセプトから、シーン単位の脚本（セリフ・感情・行分割・必要なら画像プロンプト）を生成し、**コストを最小化しつつ品質を確保**する。

本仕様は以下の節約テクニックを必須要件として実装する：
- Sonnetを「最終清書」に限定（高コストモデル使用箇所を最小化）
- 1シーンずつ生成（長文一括生成を禁止）
- 差分修正（全再生成禁止。指摘箇所のみ修正）
- 共通コンテキストのキャッシュ（毎回送る固定トークンを削減）
- 安価モデル（Haiku / Gemini 等）との役割分担

## 2. 想定ユーザー
- FANZA同人向け創作を行う制作者
- Claude CodeでCLIベースの自動生成パイプラインを回したいユーザー

## 3. 用語
- 高コストモデル：Claude Sonnet（最終清書専用）
- 低コストモデル：Claude Haiku / Gemini 等
- 共通コンテキスト：世界観、キャラ設定、口調ルール、NGルール等
- シーン入力：当該シーンに必要な最小情報

## 4. 機能要件

### 4.1 入力機能
- 作品コンセプト（必須）
- 登場人物設定（必須）
- シーン数またはページ数（必須）
- 必須要素・NG要素（任意）

### 4.2 アウトライン生成（低コストモデル）
- 出力：scene_id / goal / beats / hook
- シーン数厳守
- 長文禁止（箇条書き）

### 4.3 シーン下書き生成（低コストモデル）
- 入力：共通コンテキスト＋該当シーン情報
- 出力：構造化JSON
- dialogue配列必須
- ト書きは短文化

### 4.4 最終清書（Sonnet）
- Sonnetはこの工程のみ使用
- 短文化ルール必須
- 口調・キャラ一貫性を調整

### 4.5 自動検証
#### ローカル検証（必須）
- JSON schema一致
- 必須項目チェック
- 感情enumチェック

#### LLM検証（任意）
- 矛盾
- 口調ズレ
- NG混入

### 4.6 差分修正
- 問題箇所のみ修正
- 全再生成禁止

### 4.7 共通コンテキストキャッシュ
- context.json として保存
- シーン生成時に参照
- バージョン管理可能

### 4.8 コスト最適化制御
- シーンごとの最大トークン制限
- Sonnet使用量ログ
- 推定コスト表示

### 4.9 出力
#### JSON（必須）
- 作品＋シーン配列

#### CSV（任意）
- work_id, scene_id, speaker, emotion, line_index, line_text

## 5. 非機能要件
### 安定性
- エラー工程を明示
- 401即停止
- 500/429はリトライ

### セキュリティ
- APIキーは環境変数

### 可観測性
- モデル・トークン・コストログ保存

## 6. 推奨ディレクトリ構成
project/
 ├─ context/
 ├─ outlines/
 ├─ drafts/
 ├─ final/
 ├─ exports/
 └─ logs/

## 7. 処理フロー
1. コンセプト入力
2. 共通コンテキスト生成
3. アウトライン生成
4. シーンごとに：
   - 下書き生成（低コスト）
   - 最終清書（Sonnet）
   - 検証
   - 必要なら差分修正
5. JSON統合
6. CSV出力
7. コスト集計

## 8. 受け入れ基準
- Sonnetは最終清書のみ
- 生成は1シーン単位
- 差分修正可能
- 共通コンテキストキャッシュあり
- JSONとCSVが正常出力される
