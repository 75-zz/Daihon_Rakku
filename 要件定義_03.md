# 要件定義書  
## 汎用二次創作キャラクター自動解析＆Skill生成システム

---

## 1. 目的

ユーザーが入力した

- 作品名
- キャラクター名

をもとに、

1. Web検索によりキャラクター情報を収集  
2. 抽象化された「キャラバイブル（構造化JSON）」を自動生成  
3. 当該キャラ専用の `.skill.md` を自動生成  
4. 二次創作脚本生成パイプラインで再利用可能にする  

ことを目的とする。

---

## 2. 前提条件

- 対象は既存のフィクションキャラクター
- 原作テキストを保存・再配布しない
- 原作セリフの再現は禁止
- 出力は「構造情報」のみ抽出する

---

## 3. システム全体構成

ユーザー入力  
↓  
Web検索モジュール  
↓  
情報抽出・要約モジュール  
↓  
キャラバイブル生成  
↓  
Skill生成  
↓  
キャラ再現パイプラインで使用  

---

## 4. 入力仕様

### 必須入力
- 作品名（string）
- キャラクター名（string）

### 任意入力
- 言語（ja / en）
- 参照優先ドメイン
- キャラID（未指定時は自動生成）

---

## 5. 機能要件

### 5.1 Web検索モジュール

- 検索APIを使用（Google/Bing/SerpAPI等）
- 上位5〜10件のページURLを取得
- 優先順位：
  - 公式サイト
  - Wikipedia
  - 公式資料
  - 大規模ファンWiki

保存ファイル：
`./sources/<char_id>_sources.json`

保存内容：
- URL
- ページタイトル
- 取得日時
- 抜粋テキスト（最大1000文字以内）
- 要約テキスト

---

### 5.2 情報抽象化モジュール

出力：
`./characters/<char_id>.json`

---

## 6. キャラバイブル構造仕様

```json
{
  "work_title": "",
  "character_name": "",
  "core_traits": [],
  "values": [],
  "fears": [],
  "relationship_style": {
    "toward_love_interest": "",
    "toward_rival": "",
    "toward_friends": ""
  },
  "speech_profile": {
    "first_person": "",
    "second_person_style": "",
    "formality_level": 0,
    "sentence_length": "short|medium|long",
    "rhythm": "",
    "typical_tone": "",
    "forbidden_elements": []
  },
  "emotion_model": {
    "baseline_state": "",
    "triggers": [],
    "escalation_pattern": [],
    "deescalation_pattern": []
  },
  "conflict_response_style": "",
  "romantic_response_style": "",
  "originality_guard": {
    "avoid_canonical_lines": true,
    "avoid_known_catchphrases": true
  }
}
```

---

## 7. Skill自動生成モジュール

出力先：
`./skills/characters/<char_id>.skill.md`

---

## 8. 生成されるSkill仕様

必須要件：
- JSONを参照する
- 原作セリフ再現禁止
- 既知の口癖の直接使用禁止
- 抽象パターン適用のみ許可

Skillテンプレ：

```md
---
name: character_voice_<char_id>
description: Apply abstract character model from ./characters/<char_id>.json
commands:
  - /voice-<char_id>
---

# Role
Rewrite dialogue to match abstract character patterns.

# Hard Rules
- Never reproduce canonical lines.
- Never copy known catchphrases.
- Use structural traits only.

# Procedure
1) Load ./characters/<char_id>.json
2) Apply speech_profile and emotion_model
3) Preserve meaning but adjust tone
4) Ensure originality
```

---

## 9. セキュリティ・法的配慮要件

禁止事項：
- 原作セリフの保存
- 長文引用の保持
- 明確に再現と分かる出力
- 決まり文句の再利用

実装要件：
- 抽出段階で引用文は削除
- 要約のみ保存
- 出力時に originality_check を行う

---

## 10. originalityチェック仕様

- 出力に固有フレーズが含まれないか確認
- 一致率チェック（将来拡張）
- 類似度判定（将来拡張）

---

## 11. CLI仕様（想定）

キャラ生成：
build_character --work "作品名" --name "キャラ名"

Skill生成のみ：
generate_skill --char_id "miku"

キャラ適用：
/voice-miku

---

## 12. キャッシュ戦略

- 既存キャラJSONが存在する場合は再生成しない
- --refresh フラグで再解析可能
- バージョン管理対応

---

## 13. 将来拡張

- 複数キャラ同時対話モード
- キャラ関係性ダイナミクス生成
- 感情曲線自動設計
- 売れ筋分析統合

---

## 14. 成功基準（Acceptance Criteria）

- 任意の作品・キャラ名でバイブル生成可能
- Skillが自動生成される
- 原作セリフが保存されない
- キャラらしさ80%以上再現（主観評価）
- 二次創作脚本生成に統合可能
